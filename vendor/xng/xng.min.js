/*!
 * ramsondon.github.io - xng.js v3.1.1 (https://ramsondon.github.io/xng)
 * Copyright 2017 -2024 Matthias Schimd <ramsondon@gmail.com> (https://ramsondon.github.io)
 * Licensed under MIT (https://github.com/ramsondon/xng/blob/master/LICENSE)
 */
!function(t,e){"function"==typeof define&&define.amd?define(["lodash"],e):"object"==typeof exports?module.exports=e(require("lodash")):t.Xng=e(t._)}(this,function(h){function e(){"use strict";return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function i(t,e,r){"use strict";if(h.isObject(e)&&h.isUndefined(r))for(var n in e)i(t,n,e[n]);else h.isString(e)&&h.isFunction(r)&&(t[e]=r)}function u(e,t,r){"use strict";h.isString(t)&&t in e?e[t](t,r):h.isArray(t)&&h.forEach(t,function(t){u(e,t,r)}),"*"in e&&e["*"](t,r)}function t(){this.memory={}}function r(){this.marker=new t,this.memory=new t}function a(t,e){"use strict";this.transformer=t||new d,this.url_prefix=e||""}function c(t,e){this.el=t||document.createElement("div"),this.model=e||{$model:{}},this.afterRenderHtmlListeners={}}function n(){}t.prototype.hit=function(t){return t in this.memory},t.prototype.fault=function(t){return!this.hit(t)},t.prototype.put=function(t,e){this.memory[t]=e},t.prototype.get=function(t){if(this.hit(t))return this.memory[t];throw new Error("cache fault")},r.prototype.cache=function(i,o){return new Promise(function(e,r){var n=h.snakeCase(i);this.marker.fault()&&this.marker.put(n,o.fetch(i)),this.marker.get(n).then(function(t){this.memory.fault(n)&&this.memory.put(n,t),e(n)}.bind(this),function(t){console.warn("resource not found: ",i,t),r(i,o)}).catch(function(){r(i,o)})}.bind(this))},r.prototype.get=function(t){return this.memory.get(t)},a.prototype.parse=function(t){"use strict";return 0<this.url_prefix.length?h.trimEnd(this.url_prefix,"/")+"/"+h.trimStart(t,"/"):t},a.prototype.fetch=function(n){return new Promise(function(e,r){var t=this.parse(n);fetch(t).then(function(t){200!==t.status?(console.warn("Error Report","Status Code: "+t.status,t.statusText),r("Error Report","Status Code: "+t.status,t.statusText)):t.text().then(function(t){this.transformer.transform(t).then(function(t){e(t)})}.bind(this))}.bind(this),r).catch(function(t){r(t)}.bind(this))}.bind(this))},c.prototype.renderHtml=function(t){var e=document.createElement("script");e.type="text/x-xng-tpl",e.innerHTML=t,this.el.appendChild(e),this.el.innerHTML=h.template(this.el.innerHTML)(this.model),this.el.innerHTML=this.el.querySelector("script").innerHTML,u(this.afterRenderHtmlListeners,"all",{el:this.el,model:this.model})},c.prototype.afterRenderHtml=function(t){i(this.afterRenderHtmlListeners,"all",t)};function o(){}function s(t){this.attribute=t,this.redirectOnInvalid=!0,this.routeMap={elements:[],routes:{}},this.listeners={}}function p(t){s.call(this,t)}function f(t){s.call(this,t),this.param="page"}function l(){this.ROUTER_FACTORY={HashRouter:p,QueryRouter:f},this.ASSIGNMENT_SYMBOL="/xng.assignment."+this.guid()+"/",this.transformers={text:new d,json:new o},this.defaultModelTransformer="json",this.attributes={view:"data-xng-view",model:"data-xng-model",listen:"data-xng-listen",route:"data-xng-route",transform:"data-xng-transform"},this.templateSettings={escape:/{{\\([\s\S]+?)}}/g,evaluate:/{%([\s\S]+?)%}/g,interpolate:/{{([\s\S]+?)}}/g},this.base_remote_dir="",this.model_cache=new r,this.tpl_cache=new r,this.router=new p(this.attributes.route),this.listeners={view:{}},this.errorTemplate='<div class="error"><h4>{{ $model.title }}</h4><p>{{ $model.message }}</p></div>'}n.prototype.doTransformation=function(t){return t},n.prototype.transform=function(r){return new Promise(function(t,e){try{t(this.doTransformation(r))}catch(t){e(r)}}.bind(this))};var d=function(){};d.prototype=Object.create(n.prototype),(o.prototype=Object.create(n.prototype)).doTransformation=function(t){return JSON.parse(t)},s.prototype.current=function(){return this.normalize(this.read())},s.prototype.l=function(){return window.location},s.prototype.read=function(){return this.l().href},s.prototype.redirect=function(t){this.l().href=t},s.prototype.normalize=function(t){return h.trim(h.trim(t||""),"/")},s.prototype.parse=function(t){return t=h.split(t=t||"",","),(t=h.compact(t)).map(function(t){return this.normalize(t)}.bind(this))},s.prototype.select=function(t){return t.querySelectorAll("["+this.attribute+"]")},s.prototype.collect=function(t){t=this.select(t);return h.forEach(t,function(e){var t;h.find(this.routeMap.elements,function(t){return t===e})||(this.routeMap.elements.push(e),t=e.getAttribute(this.attribute),this.parse(t).forEach(function(t){t in this.routeMap.routes||(this.routeMap.routes[t]={route:t,elements:[]}),h.find(this.routeMap.routes[t].elements,function(t){return t===e})||this.routeMap.routes[t].elements.push(e)}.bind(this)))}.bind(this)),t.length},s.prototype.link=function(t){return t},s.prototype.listen=function(){var t=this.current(),e=function(t){return t in this.routeMap.routes}.bind(this),r=function(t){0<this.routeMap.elements.length&&t in this.routeMap.routes&&(t=this.routeMap.routes[t],this.routeMap.elements.forEach(function(t){t.style.display="none"}),t.elements.forEach(function(t){t.style.display=""}),u(this.listeners,t.routes))}.bind(this);e(t)?r(t):t.length<=0&&e(".")?r("."):t.length<=0?r(h.first(this.routeMap.routes)):this.redirectOnInvalid&&this.redirect("")},(p.prototype=Object.create(s.prototype)).read=function(){return this.l().hash},p.prototype.normalize=function(t){return h.trimStart(s.prototype.normalize.apply(this,arguments),"#")},p.prototype.redirect=function(t){this.l().hash=t},p.prototype.link=function(t){return"#"+t},p.prototype.listen=function(){s.prototype.listen.apply(this,arguments),window.onhashchange=function(){s.prototype.listen.apply(this,arguments)}.bind(this)},(f.prototype=Object.create(s.prototype)).read=function(){var t=this.getQueryObject();return this.param in t?t.page:""},f.prototype.normalize=function(t){return h.trimStart(s.prototype.normalize.apply(this,arguments),"?")},f.prototype.redirect=function(t){this.l().search=t},f.prototype.getQueryObject=function(){var t=decodeURIComponent(this.l().search.substring(1));return t.length<=0?{}:JSON.parse('{"'+t.replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')},f.prototype.toQueryString=function(t,e){var r,n,i,o=[];for(r in t)t.hasOwnProperty(r)&&(n=e?e+"["+r+"]":r,i=t[r],o.push(null!==i&&"object"==typeof i?this.toQueryString(i,n):encodeURIComponent(n)+"="+encodeURIComponent(i)));return o.join("&")},f.prototype.link=function(t){var e=this.getQueryObject();return e[this.param]=t,"?"+this.toQueryString(e)+this.l().hash},f.prototype.listen=function(){s.prototype.listen.apply(this,arguments)};return l.prototype.createTransformer=function(t){function e(){}return(e.prototype=Object.create(this.defaultTransformer().prototype)).doTransformation=t,e},l.prototype.defaultTransformer=function(){return n},l.prototype.using=function(t){t=this.ROUTER_FACTORY[t];return this.router=new t(this.attributes.route),this},l.prototype.link=function(t){return this.router.link(t)},l.prototype.fetch=function(t,e){return new a(this.transformers[e],this.base_remote_dir).fetch(t)},l.prototype.render=function(n,i,o,s){return new Promise(function(e){var r=new c(o,i);r.afterRenderHtml(function(){var t=o.querySelectorAll("["+this.attributes.view+"]");this.include(t).then(function(){e(),u(this.listeners.view,s,o)}.bind(this))}.bind(this)),this.tpl_cache.cache(n,new a(this.transformers.text,this.base_remote_dir)).then(function(t){r.renderHtml(this.tpl_cache.get(t))}.bind(this),function(t,e){r.model=h.cloneDeep(i),r.model.$model={title:"resource not found",message:"resource "+n+" could not be loaded!"},r.renderHtml(this.errorTemplate),console.warn("resource not found: ",n)}.bind(this)).catch(function(t){console.warn("error has been catched",t)})}.bind(this))},l.prototype.put=function(t,e,r){e=document.querySelector(e);e.innerHTML=t,u(this.listeners.view,r,e)},l.prototype.guid=function(){var t=e;return[t()+t(),t(),t(),t(),t()+t()+t()].join("-")},l.prototype.parseDirectives=function(t){return{model:t.getAttribute(this.attributes.model),template:t.getAttribute(this.attributes.view),listener:t.getAttribute(this.attributes.listen),transform:t.getAttribute(this.attributes.transform)||this.defaultModelTransformer}},l.prototype.include=function(s){return new Promise(function(n){var i=0,o=function(t,e,r){this.render(t.template,{$route:this.router.current(),$model:e},r,t.listener).then(function(){++i===s.length&&n()}.bind(this))}.bind(this);h.forEach(s,function(e){var r=this.parseDirectives(e);r.model?this.readAssignment(r.model,this.transformers[r.transform]).then(function(t){o(r,t,e)},function(){var t=new a(this.transformers[r.transform],this.base_remote_dir);this.model_cache.cache(r.model,t).then(function(t){o(r,this.model_cache.get(t),e)}.bind(this),function(t){o(r,{},e),console.warn("model resource not found: ",t)}.bind(this)).catch(function(t){console.warn(t)})}.bind(this)):o(r,null,e)}.bind(this)),s.length<=0&&n()}.bind(this))},l.prototype.nl2br=function(t,e){return h.isString(t)?(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(e||void 0===e?"<br />":"<br>")+"$2"):t},l.prototype.assign=function(t){return h.escape(this.ASSIGNMENT_SYMBOL+JSON.stringify(h.toPlainObject(t)))},l.prototype.readAssignment=function(t,e){var r=h.unescape(t);return h.startsWith(r,this.ASSIGNMENT_SYMBOL)?(r=r.replace(this.ASSIGNMENT_SYMBOL,""),e.transform(r)):new Promise(function(t,e){e(r)})},l.prototype.base=function(t){return this.base_remote_dir=t,this},l.prototype.route=function(t,e){return i(this.router.listeners,t,e),this},l.prototype.transform=function(t,e){if(h.isString(t)&&h.isFunction(e)){var r=this.createTransformer(e);this.transform(t,new r)}else if(h.isObject(t)&&h.isUndefined(e))for(var n in t)this.transform(n,t[n]);else h.isString(t)&&!h.isUndefined(e)&&(this.transformers[t]=e);return this},l.prototype.listen=function(t,e){return i(this.listeners.view,t,e),this},l.prototype.require=function(o,c){return new Promise(function(r){function n(t,e,r,n){var i,o=r.replace(new RegExp("[/.:]","g"),"_"),s=t.getElementsByTagName(e)[0];if(!t.getElementById(o)){if((i=t.createElement(e)).id=o,i.src=r,h.isString(c)&&i.setAttribute(c,""),h.isObject(c))for(var u in c)i.setAttribute(u,c[u]);if(h.isArray(c))for(var a=0;a<c.length;a++)i.setAttribute(c[a],"");s.parentNode.insertBefore(i,s),i.readyState?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||(i.onreadystatechange=null,n(r))}:i.onload=function(){n(r)}}}var i;h.isString(o)?n(document,"script",o,r):(i=0,h.forEach(o,function(t,e){n(document,"script",t,function(){i++>=o.length-1&&r(o)})}))}.bind(this))},l.prototype.run=function(){h.assign(h.templateSettings,this.templateSettings),this.router.attribute=this.attributes.route;var t=this.include(document.querySelectorAll("["+this.attributes.view+"]"));return t.then(function(){this.router.collect(document),this.router.listen()}.bind(this)),t},h.xng||(h.xng=new l),l});